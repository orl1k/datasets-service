{% extends "layout.html" %}

{% block content %}

<form class="ui form error">
    <div class="ui hidden divider"></div>
    <h1 class="ui center aligned icon header ">
        <i class="file alternate outline icon"></i>
        <div class="content">
            DatasetsAPI
            <div class="sub header">Enter script arguments and run the script</div>
        </div>
    </h1>
    <div class="ui hidden divider"></div>

    <h2 class="ui dividing header ">
        <i class="calendar outline icon"></i>
        <div class="content">
            Dataset date
        </div>
    </h2>

    <div class="ui form">
        <div class="field">
            <div class="ui calendar" id="dataset_calendar">
                <div class="ui input left icon">
                    <i class="calendar icon"></i>
                    <input type="text" placeholder="Pick up a date" name="dataset_date" id="dataset_date">
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        $('#dataset_calendar')
            .calendar({
                type: 'date',
                formatter: {
                    date: function (date, settings) {
                        if (!date) return '';
                        var day = date.getDate();
                        var month = date.getMonth() + 1;
                        var year = date.getFullYear();
                        return year + '-' + month + '-' + day;
                    }
                }
            })
            ;

    </script>

    <h2 class="ui dividing header">
        <i class="folder outline icon"></i>
        <div class="content">
            Paths
        </div>
    </h2>
    <div class="two fields">
        <div class="field">
            <label>Rasters</label>
            <input name="rasters_path" type="text" placeholder="Enter rasters path" value="/mnt/Gold2/rasters">
        </div>
        <div class="field">
            <label>Datasets</label>
            <input name="datasets_path" type="text" placeholder="Enter datasets path" value="/mnt/Gold1/datasets">
        </div>
    </div>
    <div class="two fields">
        <div class="field">
            <label>Icemaps</label>
            <input name="icemaps_path" type="text" placeholder="Enter icemaps path" value="/mnt/Gold2/ice_maps/KAR">
        </div>
        <div class="field">
            <label>Land shape</label>
            <input name="land_path" type="text" placeholder="Enter land shape path"
                value="/mnt/Gold2/land/bigger/Shore_20191212.shp">
        </div>

    </div>

    <h2 class="ui dividing header">
        <i class="tasks icon"></i>
        <div class="content">
            Other
        </div>
    </h2>

    <div class="ui top attached three column center aligned divided grid segment">
        <div class="column">
            <div class="ui checkbox">
                <input type="hidden" name="age" value="1"><input type="checkbox" checked="checked"
                    onclick="this.previousSibling.value=1-this.previousSibling.value">
                <label>age</label>
            </div>
        </div>
        <div class="column">
            <div class="ui checkbox">
                <input type="hidden" name="concentrat" value="1"><input type="checkbox" checked="checked"
                    onclick="this.previousSibling.value=1-this.previousSibling.value">
                <label>concentrat</label>
            </div>
        </div>
        <div class="column">
            <div class="ui checkbox">
                <input type="hidden" name="age_group" value="1"><input type="checkbox" checked="checked"
                    onclick="this.previousSibling.value=1-this.previousSibling.value">
                <label>age_group</label>
            </div>
        </div>
    </div>
    <div class="ui top attached three column center aligned divided grid segment">
        <div class="column">
            <div class="ui checkbox">
                <input type="hidden" name="advanced" value="1"><input type="checkbox" checked="checked"
                    onclick="this.previousSibling.value=1-this.previousSibling.value">
                <label>advanced</label>
            </div>
        </div>
        <div class="column">
            <div class="ui checkbox">
                <input type="hidden" name="simple" value="1"><input type="checkbox" checked="checked"
                    onclick="this.previousSibling.value=1-this.previousSibling.value">
                <label>simple</label>
            </div>
        </div>
    </div>

    <h2 class="ui dividing header">
        <i class="exclamation icon"></i>
        <div class="content">
            Priority
        </div>
    </h2>

    <div class="ui hidden divider"></div>

    <div class="ui labeled slider" id="task_priority_slider"></div>
    <div class="ui input">
        <input id="task_priority" type="hidden" value="5" name="task_priority">
    </div>

    <script>
        $('.ui.slider')
            .slider({
                min: 0,
                max: 10,
                start: 5,
                step: 1,
                onChange: function () {
                    $("#task_priority")
                        .val(
                            $(this).slider('get value')
                        )
                }
            });
    </script>

    <div class="ui basic segment center aligned">
        <button class="ui massive animated button" type="submit" id="submit" tabindex="0">
            <div class="visible content">Start script</div>
            <div class="hidden content">
                <i class="angle double right icon"></i>
            </div>
        </button>
        <a href="http://127.0.0.1:5555/" class="ui small image">
            <img src="/static/celery_icon.png">
        </a>
    </div>

    <script>
        $('.ui.form')
            .form({
                fields: {
                    dataset_date: {
                        identifier: 'dataset_date',
                        rules: [
                            {
                                type: 'empty',
                                prompt: 'Please select a dataset date'
                            }
                        ]
                    },
                    rasters_path: {
                        identifier: 'rasters_path',
                        rules: [
                            {
                                type: 'empty',
                                prompt: 'Please select a rasters path'
                            }
                        ]
                    },
                    datasets_path: {
                        identifier: 'datasets_path',
                        rules: [
                            {
                                type: 'empty',
                                prompt: 'Please select a datasets path'
                            }
                        ]
                    },
                    icemaps_path: {
                        identifier: 'icemaps_path',
                        rules: [
                            {
                                type: 'empty',
                                prompt: 'Please select a icemaps path'
                            }
                        ]
                    },
                    land_path: {
                        identifier: 'land_path',
                        rules: [
                            {
                                type: 'empty',
                                prompt: 'Please select a earth shape path'
                            }
                        ]
                    },
                }
            })
            ;
    </script>

    <script>
        $(document).ready(function () {
            $("#submit").click(function (e) {
                e.preventDefault();
                var form = $(this).parents("form:first");
                $.ajax({
                    type: 'POST',
                    url: '/script',
                    data: form.serialize(),
                    success: function (response) {
                        $('body')
                            .toast({
                                title: 'SUCCESS',
                                class: 'success',
                                message: 'Script started with task id: ' + response['task_id'] + ' ' + response['task_url'],
                                showProgress: 'bottom',
                                progressUp: true,
                                position: 'top attached',
                                transition: {
                                    showMethod: 'fade down',
                                    hideMethod: 'fade down',
                                }
                            });
                    },
                    error: function (response) {
                        $('body')
                            .toast({
                                title: 'ERROR',
                                class: 'error',
                                message: 'Script not started',
                                showProgress: 'bottom',
                                progressUp: true,
                                position: 'top attached',
                                transition: {
                                    showMethod: 'fade down',
                                    hideMethod: 'fade down',
                                }
                            });
                    }
                });
            });
        })
    </script>

</form>
<table class="ui very basic collapsing celled table" id="task_table">
    <thead>
        <tr>
            <th class="center aligned">Task ID</th>
            <th class="center aligned">State</th>
            <th class="center aligned">Params</th>
        </tr>
    </thead>
    <tbody>
        {% for task in tasks %}
        <tr>
            <td class="center aligned">{{ task['task_id'] }}</td>
            <td class="center aligned  {{ task['class'] }}"><i class="icon {{ task['icon'] }}"></i> {{ task['state'] }}
            <td class="center aligned">{{ task['info'] }}</td>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="ui hidden divider"></div>
<!-- Refresh button -->
<!-- <button class="ui massive button" id='refresh-btn'>
    <i class="sync alternate icon"></i>
    Refresh
</button> -->

<script>
    function RefreshTable() {
        $("#task_table").load("/ #task_table");
    }

    setInterval(function () {
        RefreshTable();
    }, 20000);

    // For refresh button
    // $("#refresh-btn").on("click", RefreshTable);
</script>

{% endblock %}